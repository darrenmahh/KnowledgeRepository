<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€è‡´æ€§å“ˆå¸Œé«˜çº§äº¤äº’å¼æ¼”ç¤º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .hash-ring-container {
            position: relative;
            width: 100%;
            padding-top: 100%;
        }
        #hashRingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .log-entry {
            transition: all 0.3s ease-in-out;
            transform-origin: top;
        }
        .log-entry.new {
            transform: scaleY(0);
            opacity: 0;
        }
        .migration-animation {
            animation: pulse 0.5s ease-in-out;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #3B82F6;
            color: white;
        }
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }
        .chart-container canvas {
            position: absolute !important;
            height: 100% !important;
            width: 100% !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">ä¸€è‡´æ€§å“ˆå¸Œé«˜çº§äº¤äº’å¼æ¼”ç¤º</h1>
            <p class="mt-2 text-lg text-gray-600">æ·±åº¦ç†è§£è™šæ‹ŸèŠ‚ç‚¹ã€è´Ÿè½½å‡è¡¡ä¸æ•°æ®è¿ç§»æœºåˆ¶</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex justify-center mb-8">
            <div class="bg-white rounded-lg p-1 shadow-lg border border-gray-200">
                <button id="basicTab" class="tab-button px-4 py-2 rounded-md font-medium active">åŸºç¡€æ“ä½œ</button>
                <button id="advancedTab" class="tab-button px-4 py-2 rounded-md font-medium">é«˜çº§åŠŸèƒ½</button>
                <button id="statsTab" class="tab-button px-4 py-2 rounded-md font-medium">ç»Ÿè®¡åˆ†æ</button>
                <button id="theoryTab" class="tab-button px-4 py-2 rounded-md font-medium">ç®—æ³•åŸç†</button>
            </div>
        </div>

        <!-- Basic Tab Content -->
        <div id="basicContent" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Controls Column -->
                <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-semibold mb-6 border-b pb-3">æ§åˆ¶é¢æ¿</h2>
                    
                    <!-- Add Server -->
                    <div class="mb-6">
                        <h3 class="font-semibold mb-2 text-gray-700">1. æ·»åŠ æœåŠ¡å™¨</h3>
                        <div class="space-y-2">
                            <input type="text" id="serverName" placeholder="æœåŠ¡å™¨åç§°" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-600">è™šæ‹ŸèŠ‚ç‚¹æ•°:</label>
                                <input type="number" id="virtualNodes" value="3" min="1" max="10" class="w-20 p-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button id="addServerBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold transition shadow-sm">æ·»åŠ æœåŠ¡å™¨</button>
                        </div>
                    </div>

                    <!-- Add Key -->
                    <div class="mb-6">
                        <h3 class="font-semibold mb-2 text-gray-700">2. æ·»åŠ æ•°æ®</h3>
                        <div class="space-y-2">
                            <input type="text" id="keyName" placeholder="æ•°æ®é”®åç§°" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <button id="addKeyBtn" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold transition shadow-sm">æ·»åŠ æ•°æ®</button>
                        </div>
                    </div>
                    
                    <!-- Remove Element -->
                    <div class="mb-6">
                        <h3 class="font-semibold mb-2 text-gray-700">3. ç§»é™¤å…ƒç´ </h3>
                        <div class="space-y-2">
                            <select id="removeSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white">
                                <option value="">-- é€‰æ‹©è¦ç§»é™¤çš„å…ƒç´  --</option>
                            </select>
                            <button id="removeBtn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 font-semibold transition shadow-sm">ç§»é™¤</button>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="mb-6">
                        <h3 class="font-semibold mb-2 text-gray-700">4. å¿«é€Ÿæ“ä½œ</h3>
                        <div class="space-y-2">
                            <button id="demoScenarioBtn" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-semibold transition shadow-sm">åŠ è½½æ¼”ç¤ºåœºæ™¯</button>
                            <button id="resetBtn" class="w-full bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 font-semibold transition shadow-sm">é‡ç½®æ‰€æœ‰</button>
                        </div>
                    </div>
                </div>

                <!-- Visualization Column -->
                <div class="lg:col-span-2">
                    <div class="bg-white p-4 rounded-2xl shadow-lg border border-gray-200">
                        <h2 class="text-xl font-semibold mb-4 text-center">å“ˆå¸Œç¯å¯è§†åŒ–</h2>
                        <div class="hash-ring-container">
                            <canvas id="hashRingCanvas"></canvas>
                        </div>
                        
                        <!-- Legend -->
                        <div class="mt-4 flex flex-wrap justify-center gap-4 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
                                <span>ç‰©ç†æœåŠ¡å™¨</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-blue-300 rounded"></div>
                                <span>è™šæ‹ŸèŠ‚ç‚¹</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                                <span>æ•°æ®é”®</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-2 bg-gray-400"></div>
                                <span>æ•°æ®æ˜ å°„</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Tab Content -->
        <div id="advancedContent" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">æ‰¹é‡æ“ä½œ</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ‰¹é‡æ·»åŠ æœåŠ¡å™¨</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="batchServerCount" placeholder="æ•°é‡" min="1" max="20" class="w-20 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="batchServerPrefix" placeholder="å‰ç¼€ (å¦‚: srv)" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <button id="batchAddServersBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold transition">æ·»åŠ </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ‰¹é‡æ·»åŠ æ•°æ®</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="batchKeyCount" placeholder="æ•°é‡" min="1" max="100" class="w-20 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="batchKeyPrefix" placeholder="å‰ç¼€ (å¦‚: key)" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <button id="batchAddKeysBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold transition">æ·»åŠ </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">ç®—æ³•é…ç½®</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å“ˆå¸Œå‡½æ•°</label>
                            <select id="hashFunction" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="simple">ç®€å•å“ˆå¸Œ</option>
                                <option value="djb2">DJB2å“ˆå¸Œ</option>
                                <option value="fnv">FNVå“ˆå¸Œ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å“ˆå¸Œç¯å¤§å°</label>
                            <select id="hashRingSize" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="360">360 (åº¦)</option>
                                <option value="1024">1024</option>
                                <option value="4096">4096</option>
                                <option value="65536">65536</option>
                            </select>
                        </div>

                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="showVirtualNodes" checked class="rounded">
                                <span class="text-sm">æ˜¾ç¤ºè™šæ‹ŸèŠ‚ç‚¹</span>
                            </label>
                        </div>

                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="animateMigration" checked class="rounded">
                                <span class="text-sm">æ•°æ®è¿ç§»åŠ¨ç”»</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Virtual Nodes Info -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-4">è™šæ‹ŸèŠ‚ç‚¹è¯¦æƒ…</h3>
                    <div id="virtualNodesInfo" class="text-sm">
                        <!-- Virtual nodes info will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Tab Content -->
        <div id="statsContent" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Load Balance Stats -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">è´Ÿè½½å‡è¡¡ç»Ÿè®¡</h3>
                    <div id="loadStats" class="space-y-3">
                        <!-- Stats will be populated here -->
                    </div>
                </div>

                <!-- Load Distribution Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">è´Ÿè½½åˆ†å¸ƒå›¾</h3>
                    <div class="chart-container">
                        <canvas id="loadChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Migration History -->
            <div class="mt-8 bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h3 class="text-lg font-semibold mb-4">æ•°æ®è¿ç§»å†å²</h3>
                <div id="migrationHistory" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Migration history will be populated here -->
                </div>
            </div>
        </div>

        <!-- Theory Tab Content -->
        <div id="theoryContent" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">ç®—æ³•åŸç†</h3>
                    <div class="space-y-4 text-sm text-gray-700">
                        <div>
                            <h4 class="font-semibold text-gray-900">1. åŸºæœ¬æ¦‚å¿µ</h4>
                            <p>ä¸€è‡´æ€§å“ˆå¸Œæ˜¯ä¸€ç§åˆ†å¸ƒå¼è®¡ç®—ä¸­çš„å“ˆå¸ŒæŠ€æœ¯ï¼Œèƒ½å¤Ÿåœ¨åŠ¨æ€ç¯å¢ƒä¸­å®ç°æ•°æ®çš„å‡åŒ€åˆ†å¸ƒå’Œæœ€å°åŒ–é‡æ–°åˆ†å¸ƒã€‚</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900">2. è™šæ‹ŸèŠ‚ç‚¹</h4>
                            <p>ä¸ºäº†è§£å†³æ•°æ®åˆ†å¸ƒä¸å‡çš„é—®é¢˜ï¼Œæ¯ä¸ªç‰©ç†èŠ‚ç‚¹å¯ä»¥å¯¹åº”å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œæé«˜è´Ÿè½½å‡è¡¡æ€§ã€‚</p>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-900">3. æ•°æ®å®šä½</h4>
                            <p>æ•°æ®é€šè¿‡å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°ç¯ä¸Šï¼Œç„¶åé¡ºæ—¶é’ˆæŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ä½œä¸ºå­˜å‚¨ä½ç½®ã€‚</p>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-900">4. èŠ‚ç‚¹å¢åˆ </h4>
                            <p>æ·»åŠ æˆ–åˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œåªæœ‰ç›¸é‚»åŒºåŸŸçš„æ•°æ®éœ€è¦è¿ç§»ï¼Œå¤§å¤§å‡å°‘äº†æ•°æ®ç§»åŠ¨ã€‚</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">å¯¹æ¯”ä¼ ç»Ÿå“ˆå¸Œ</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                            <h4 class="font-semibold text-red-900 mb-2">ä¼ ç»Ÿå“ˆå¸Œ (hash % n)</h4>
                            <ul class="text-sm text-red-700 space-y-1">
                                <li>â€¢ èŠ‚ç‚¹å˜åŒ–æ—¶éœ€è¦é‡æ–°åˆ†å¸ƒæ‰€æœ‰æ•°æ®</li>
                                <li>â€¢ æ•°æ®è¿ç§»æˆæœ¬é«˜</li>
                                <li>â€¢ æ‰©å±•æ€§å·®</li>
                            </ul>
                        </div>

                        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                            <h4 class="font-semibold text-green-900 mb-2">ä¸€è‡´æ€§å“ˆå¸Œ</h4>
                            <ul class="text-sm text-green-700 space-y-1">
                                <li>â€¢ èŠ‚ç‚¹å˜åŒ–æ—¶åªè¿ç§»ç›¸é‚»æ•°æ®</li>
                                <li>â€¢ æ•°æ®è¿ç§»æˆæœ¬ä½</li>
                                <li>â€¢ æ‰©å±•æ€§å¥½</li>
                                <li>â€¢ æ”¯æŒè™šæ‹ŸèŠ‚ç‚¹æé«˜å‡è¡¡æ€§</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log Column -->
        <div class="mt-8 bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold border-b pb-3">æ“ä½œæ—¥å¿—</h2>
                <div class="space-x-2">
                    <button id="clearLogBtn" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition">æ¸…ç©ºæ—¥å¿—</button>
                    <button id="exportLogBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition">å¯¼å‡ºæ—¥å¿—</button>
                </div>
            </div>
            <div id="logContainer" class="space-y-2 text-sm font-mono max-h-64 overflow-y-auto">
                <!-- Log entries will be added here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const canvas = document.getElementById('hashRingCanvas');
        const ctx = canvas.getContext('2d');
        
        // Input elements
        const serverNameInput = document.getElementById('serverName');
        const virtualNodesInput = document.getElementById('virtualNodes');
        const addServerBtn = document.getElementById('addServerBtn');
        const keyNameInput = document.getElementById('keyName');
        const addKeyBtn = document.getElementById('addKeyBtn');
        const removeSelect = document.getElementById('removeSelect');
        const removeBtn = document.getElementById('removeBtn');
        const resetBtn = document.getElementById('resetBtn');
        const demoScenarioBtn = document.getElementById('demoScenarioBtn');
        const logContainer = document.getElementById('logContainer');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const exportLogBtn = document.getElementById('exportLogBtn');

        // Advanced controls
        const batchServerCountInput = document.getElementById('batchServerCount');
        const batchServerPrefixInput = document.getElementById('batchServerPrefix');
        const batchAddServersBtn = document.getElementById('batchAddServersBtn');
        const batchKeyCountInput = document.getElementById('batchKeyCount');
        const batchKeyPrefixInput = document.getElementById('batchKeyPrefix');
        const batchAddKeysBtn = document.getElementById('batchAddKeysBtn');
        const hashFunctionSelect = document.getElementById('hashFunction');
        const hashRingSizeSelect = document.getElementById('hashRingSize');
        const showVirtualNodesCheckbox = document.getElementById('showVirtualNodes');
        const animateMigrationCheckbox = document.getElementById('animateMigration');

        // Tab elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Data structures
        let servers = [];
        let virtualNodes = [];
        let keys = [];
        let migrationHistory = [];
        let currentHashRingSize = 360;
        
        const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1', '#F97316', '#06B6D4', '#84CC16'];
        let colorIndex = 0;

        // Chart instance
        let loadChart = null;

        // Hash functions
        const hashFunctions = {
            simple: function(str) {
                let hash = 0;
                if (str.length === 0) return hash;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash) % currentHashRingSize;
            },

            djb2: function(str) {
                let hash = 5381;
                for (let i = 0; i < str.length; i++) {
                    hash = ((hash << 5) + hash) + str.charCodeAt(i);
                }
                return Math.abs(hash) % currentHashRingSize;
            },

            fnv: function(str) {
                let hash = 0x811c9dc5;
                for (let i = 0; i < str.length; i++) {
                    hash ^= str.charCodeAt(i);
                    hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
                }
                return Math.abs(hash) % currentHashRingSize;
            }
        };

        function getCurrentHashFunction() {
            return hashFunctions[hashFunctionSelect.value] || hashFunctions.simple;
        }

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry p-2 rounded-md';
            
            let bgColor, textColor, icon;
            switch(type) {
                case 'add':
                    bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; icon = 'âœš'; break;
                case 'add_key':
                    bgColor = 'bg-green-100'; textColor = 'text-green-800'; icon = 'âœš'; break;
                case 'remove':
                    bgColor = 'bg-red-100'; textColor = 'text-red-800'; icon = 'âœ–'; break;
                case 'remap':
                    bgColor = 'bg-yellow-100'; textColor = 'text-yellow-800'; icon = 'â‡„'; break;
                case 'batch':
                    bgColor = 'bg-purple-100'; textColor = 'text-purple-800'; icon = 'âš¡'; break;
                case 'error':
                    bgColor = 'bg-red-100'; textColor = 'text-red-800'; icon = 'âš '; break;
                default:
                    bgColor = 'bg-gray-100'; textColor = 'text-gray-800'; icon = 'â“˜';
            }

            entry.classList.add(bgColor, textColor);
            entry.innerHTML = `<span class="font-bold mr-2">${icon}</span> <span class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</span> ${message}`;
            
            entry.classList.add('new');
            logContainer.prepend(entry);
            setTimeout(() => {
                entry.classList.remove('new');
                requestAnimationFrame(() => {
                    entry.style.transform = 'scaleY(1)';
                    entry.style.opacity = '1';
                });
            }, 10);
        }

        function createVirtualNodes(server) {
            const virtualNodeCount = parseInt(virtualNodesInput.value) || 3;
            const serverVirtualNodes = [];
            
            for (let i = 0; i < virtualNodeCount; i++) {
                const virtualNodeName = `${server.name}#${i}`;
                const hash = getCurrentHashFunction()(virtualNodeName);
                serverVirtualNodes.push({
                    name: virtualNodeName,
                    hash: hash,
                    server: server,
                    isVirtual: true
                });
            }
            
            return serverVirtualNodes;
        }

        function updateRemoveOptions() {
            removeSelect.innerHTML = '<option value="">-- é€‰æ‹©è¦ç§»é™¤çš„å…ƒç´  --</option>';
            
            servers.forEach(s => {
                const option = document.createElement('option');
                option.value = `server_${s.name}`;
                option.textContent = `æœåŠ¡å™¨: ${s.name} (${s.keyCount || 0} ä¸ªæ•°æ®)`;
                removeSelect.appendChild(option);
            });
            
            keys.forEach(k => {
                const option = document.createElement('option');
                option.value = `key_${k.name}`;
                option.textContent = `æ•°æ®: ${k.name} â†’ ${k.server ? k.server.name : 'æ— æœåŠ¡å™¨'}`;
                removeSelect.appendChild(option);
            });
        }

        function findTargetServer(keyHash) {
            if (virtualNodes.length === 0) return null;
            
            const sortedVirtualNodes = [...virtualNodes].sort((a, b) => a.hash - b.hash);

            for (let vnode of sortedVirtualNodes) {
                if (vnode.hash >= keyHash) {
                    return vnode.server;
                }
            }
            
            return sortedVirtualNodes[0].server;
        }

        function findTargetVirtualNode(keyHash) {
            if (virtualNodes.length === 0) return null;
            
            const sortedVirtualNodes = [...virtualNodes].sort((a, b) => a.hash - b.hash);

            for (let vnode of sortedVirtualNodes) {
                if (vnode.hash >= keyHash) {
                    return vnode;
                }
            }
            
            return sortedVirtualNodes[0];
        }

        function remapKeys() {
            const migrations = [];
            
            keys.forEach(key => {
                const oldServer = key.server;
                const newServer = findTargetServer(key.hash);
                
                if (oldServer !== newServer) {
                    migrations.push({
                        key: key.name,
                        from: oldServer ? oldServer.name : 'æ— ',
                        to: newServer ? newServer.name : 'æ— ',
                        timestamp: new Date()
                    });
                }
                
                key.server = newServer;
            });

            // Update server key counts
            servers.forEach(server => server.keyCount = 0);
            keys.forEach(key => {
                if (key.server) {
                    key.server.keyCount = (key.server.keyCount || 0) + 1;
                }
            });

            // Log migrations
            migrations.forEach(migration => {
                addLog(`æ•°æ® '${migration.key}' ä» '${migration.from}' è¿ç§»åˆ° '${migration.to}'`, 'remap');
                migrationHistory.unshift(migration);
            });

            // Keep migration history limited
            if (migrationHistory.length > 100) {
                migrationHistory = migrationHistory.slice(0, 100);
            }

            updateStatistics();
            updateVirtualNodesInfo();
            draw();
        }

        function updateVirtualNodesInfo() {
            const virtualNodesInfoDiv = document.getElementById('virtualNodesInfo');
            if (!virtualNodesInfoDiv) return;

            if (virtualNodes.length === 0) {
                virtualNodesInfoDiv.innerHTML = '<p class="text-gray-500">æš‚æ— è™šæ‹ŸèŠ‚ç‚¹</p>';
                return;
            }

            const sortedVirtualNodes = [...virtualNodes].sort((a, b) => a.hash - b.hash);
            
            virtualNodesInfoDiv.innerHTML = `
                <div class="mb-4">
                    <p class="text-gray-600 mb-2">ç¯ä¸Šå…±æœ‰ ${virtualNodes.length} ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼ŒæŒ‰å“ˆå¸Œå€¼æ’åºï¼š</p>
                    <div class="grid gap-2 max-h-64 overflow-y-auto">
                        ${sortedVirtualNodes.map(vnode => `
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded border-l-4" style="border-left-color: ${vnode.server.color}">
                                <span class="font-medium">${vnode.name}</span>
                                <div class="text-right">
                                    <span class="text-gray-600">å“ˆå¸Œ: ${vnode.hash}</span>
                                    <span class="ml-2 text-xs px-2 py-1 rounded" style="background-color: ${vnode.server.color}20; color: ${vnode.server.color}">â†’ ${vnode.server.name}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 class="font-semibold text-blue-900 mb-2">ğŸ’¡ ä¸ºä»€ä¹ˆæ˜ å°„ç»“æœå¯èƒ½å‡ºä¹æ„æ–™ï¼Ÿ</h4>
                    <p class="text-blue-800 text-sm">
                        ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä½¿ç”¨è™šæ‹ŸèŠ‚ç‚¹æ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚æ•°æ®çš„æ˜ å°„æ˜¯åŸºäº<strong>è™šæ‹ŸèŠ‚ç‚¹çš„å“ˆå¸Œå€¼</strong>ï¼Œè€Œä¸æ˜¯ç‰©ç†æœåŠ¡å™¨çš„å“ˆå¸Œå€¼ã€‚
                        æ¯ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„åç§°ä¸º "æœåŠ¡å™¨å#åºå·"ï¼Œå› æ­¤å…¶å“ˆå¸Œå€¼ä¸ç‰©ç†æœåŠ¡å™¨ä¸åŒã€‚
                    </p>
                </div>
            `;
        }

        function updateStatistics() {
            const loadStats = document.getElementById('loadStats');
            const migrationHistoryDiv = document.getElementById('migrationHistory');
            
            if (loadStats) {
                loadStats.innerHTML = '';
                
                if (servers.length === 0) {
                    loadStats.innerHTML = '<p class="text-gray-500">æš‚æ— æœåŠ¡å™¨æ•°æ®</p>';
                } else {
                    // Calculate load balance metrics
                    const avgLoad = keys.length / servers.length;
                    const loadVariance = servers.reduce((sum, server) => {
                        const diff = (server.keyCount || 0) - avgLoad;
                        return sum + diff * diff;
                    }, 0) / servers.length;
                    const loadStdDev = Math.sqrt(loadVariance);
                    const balanceScore = Math.max(0, 100 - (loadStdDev / avgLoad * 100));

                    loadStats.innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-blue-50 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">${keys.length}</div>
                                <div class="text-sm text-blue-600">æ€»æ•°æ®é‡</div>
                            </div>
                            <div class="text-center p-3 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">${servers.length}</div>
                                <div class="text-sm text-green-600">æœåŠ¡å™¨æ•°é‡</div>
                            </div>
                            <div class="text-center p-3 bg-yellow-50 rounded-lg">
                                <div class="text-2xl font-bold text-yellow-600">${avgLoad.toFixed(1)}</div>
                                <div class="text-sm text-yellow-600">å¹³å‡è´Ÿè½½</div>
                            </div>
                            <div class="text-center p-3 bg-purple-50 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600">${isNaN(balanceScore) ? 'N/A' : balanceScore.toFixed(1)}%</div>
                                <div class="text-sm text-purple-600">å‡è¡¡åˆ†æ•°</div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-semibold mb-2">æœåŠ¡å™¨è´Ÿè½½è¯¦æƒ…</h4>
                            ${servers.map(server => `
                                <div class="flex justify-between items-center py-1 border-b border-gray-100">
                                    <span class="font-medium" style="color: ${server.color}">${server.name}</span>
                                    <span class="text-sm">${server.keyCount || 0} ä¸ªæ•°æ®</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            // Update migration history
            if (migrationHistoryDiv) {
                migrationHistoryDiv.innerHTML = migrationHistory.length === 0 
                    ? '<p class="text-gray-500">æš‚æ— è¿ç§»è®°å½•</p>'
                    : migrationHistory.slice(0, 10).map(migration => `
                        <div class="p-2 bg-gray-50 rounded text-xs">
                            <span class="font-medium">${migration.key}</span>: 
                            ${migration.from} â†’ ${migration.to}
                            <span class="text-gray-400 float-right">${migration.timestamp.toLocaleTimeString()}</span>
                        </div>
                    `).join('');
            }

            updateLoadChart();
        }

        function updateLoadChart() {
            const chartContainer = document.querySelector('.chart-container');
            if (!chartContainer) return;

            // Destroy existing chart
            if (loadChart) {
                loadChart.destroy();
                loadChart = null;
            }

            if (servers.length === 0) {
                // Show placeholder
                chartContainer.innerHTML = `
                    <div class="chart-container flex items-center justify-center text-gray-500">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ğŸ“Š</div>
                            <div>æš‚æ— æ•°æ®</div>
                            <div class="text-sm">è¯·å…ˆæ·»åŠ æœåŠ¡å™¨å’Œæ•°æ®</div>
                        </div>
                    </div>
                `;
                return;
            }

            // Ensure canvas exists
            chartContainer.innerHTML = '<canvas id="loadChart"></canvas>';
            const canvas = document.getElementById('loadChart');
            const ctx = canvas.getContext('2d');

            // Create new chart
            loadChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: servers.map(s => s.name),
                    datasets: [{
                        data: servers.map(s => s.keyCount || 0),
                        backgroundColor: servers.map(s => s.color),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    resizeDelay: 0,
                    layout: {
                        padding: 10
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function draw() {
            const w = canvas.width;
            const h = canvas.height;
            const radius = Math.min(w, h) * 0.35;
            const centerX = w / 2;
            const centerY = h / 2;
            
            ctx.clearRect(0, 0, w, h);

            // Draw the hash ring
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = '#E5E7EB';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Draw hash value markers
            const markerCount = currentHashRingSize === 360 ? 8 : 16;
            const markerStep = currentHashRingSize / markerCount;
            
            for (let i = 0; i < markerCount; i++) {
                const angle = (i * markerStep) * (currentHashRingSize === 360 ? Math.PI / 180 : 2 * Math.PI / currentHashRingSize);
                const x1 = centerX + radius * Math.cos(angle);
                const y1 = centerY + radius * Math.sin(angle);
                const x2 = centerX + (radius - 8) * Math.cos(angle);
                const y2 = centerY + (radius - 8) * Math.sin(angle);
                
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.strokeStyle = '#9CA3AF';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Draw marker labels
                ctx.fillStyle = '#6B7280';
                ctx.font = '10px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const textX = centerX + (radius + 15) * Math.cos(angle);
                const textY = centerY + (radius + 15) * Math.sin(angle);
                ctx.fillText((i * markerStep).toString(), textX, textY);
            }

            // Draw virtual nodes (if enabled)
            if (showVirtualNodesCheckbox.checked) {
                virtualNodes.forEach(vnode => {
                    const angle = vnode.hash * (currentHashRingSize === 360 ? Math.PI / 180 : 2 * Math.PI / currentHashRingSize);
                    const x = centerX + radius * Math.cos(angle);
                    const y = centerY + radius * Math.sin(angle);

                    ctx.beginPath();
                    ctx.rect(x - 4, y - 4, 8, 8);
                    ctx.fillStyle = vnode.server.color + '80'; // Semi-transparent
                    ctx.fill();
                    ctx.strokeStyle = vnode.server.color;
                    ctx.lineWidth = 1;
                    ctx.stroke();
                });
            }

            // Draw physical servers
            servers.forEach(server => {
                const angle = server.hash * (currentHashRingSize === 360 ? Math.PI / 180 : 2 * Math.PI / currentHashRingSize);
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                // Server node
                ctx.beginPath();
                ctx.arc(x, y, 10, 0, 2 * Math.PI);
                ctx.fillStyle = server.color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Server label
                ctx.fillStyle = '#1F2937';
                ctx.font = 'bold 12px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const textX = centerX + (radius + 30) * Math.cos(angle);
                const textY = centerY + (radius + 30) * Math.sin(angle);
                ctx.fillText(`${server.name} (${server.keyCount || 0})`, textX, textY);
            });

            // Draw keys and connections
            keys.forEach(key => {
                const keyAngle = key.hash * (currentHashRingSize === 360 ? Math.PI / 180 : 2 * Math.PI / currentHashRingSize);
                const keyX = centerX + radius * Math.cos(keyAngle);
                const keyY = centerY + radius * Math.sin(keyAngle);

                // Key node
                ctx.beginPath();
                ctx.arc(keyX, keyY, 4, 0, 2 * Math.PI);
                ctx.fillStyle = key.server ? key.server.color : '#9CA3AF';
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.stroke();

                // Connection to server
                if (key.server) {
                    const serverAngle = key.server.hash * (currentHashRingSize === 360 ? Math.PI / 180 : 2 * Math.PI / currentHashRingSize);
                    const serverX = centerX + radius * Math.cos(serverAngle);
                    const serverY = centerY + radius * Math.sin(serverAngle);
                    
                    ctx.beginPath();
                    ctx.moveTo(keyX, keyY);
                    ctx.lineTo(serverX, serverY);
                    ctx.strokeStyle = key.server.color + '60';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([2, 2]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                // Key label
                ctx.fillStyle = '#4B5563';
                ctx.font = '10px Inter';
                const textAngle = keyAngle;
                const textRadius = radius * 0.8;
                const textX = centerX + textRadius * Math.cos(textAngle);
                const textY = centerY + textRadius * Math.sin(textAngle);
                ctx.save();
                ctx.translate(textX, textY);
                ctx.rotate(textAngle + Math.PI/2);
                ctx.textAlign = "center";
                ctx.fillText(key.name, 0, 0);
                ctx.restore();
            });
        }

        function handleResize() {
            const container = canvas.parentElement;
            const size = Math.min(container.clientWidth, 500);
            canvas.width = size;
            canvas.height = size;
            draw();
        }

        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.id.replace('Tab', 'Content');
                
                // Update active tab button
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Show target content
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Event Listeners
        addServerBtn.addEventListener('click', () => {
            const name = serverNameInput.value.trim();
            if (name && !servers.find(s => s.name === name)) {
                const hash = getCurrentHashFunction()(name);
                const color = colors[colorIndex % colors.length];
                colorIndex++;
                
                const server = { 
                    name, 
                    hash, 
                    color,
                    keyCount: 0
                };
                
                servers.push(server);
                
                // Create virtual nodes
                const serverVirtualNodes = createVirtualNodes(server);
                virtualNodes.push(...serverVirtualNodes);
                
                addLog(`æ·»åŠ æœåŠ¡å™¨ '${name}' (å“ˆå¸Œ: ${hash}, ${serverVirtualNodes.length} ä¸ªè™šæ‹ŸèŠ‚ç‚¹)`, 'add');
                serverNameInput.value = '';
                remapKeys();
                updateRemoveOptions();
                updateVirtualNodesInfo();
            } else if (!name) {
                addLog('è¯·è¾“å…¥æœåŠ¡å™¨åç§°', 'error');
            } else {
                addLog(`æœåŠ¡å™¨ '${name}' å·²å­˜åœ¨`, 'error');
            }
        });

        addKeyBtn.addEventListener('click', () => {
            const name = keyNameInput.value.trim();
            if (name && !keys.find(k => k.name === name)) {
                const hash = getCurrentHashFunction()(name);
                const server = findTargetServer(hash);
                const key = { name, hash, server };
                
                keys.push(key);
                
                if (server) {
                    server.keyCount = (server.keyCount || 0) + 1;
                }
                
                keyNameInput.value = '';
                // Find the specific virtual node that this key maps to
                const targetVirtualNode = findTargetVirtualNode(hash);
                
                addLog(`æ·»åŠ æ•°æ® '${name}' (å“ˆå¸Œ: ${hash}) â†’ ${server ? server.name : 'æ— æœåŠ¡å™¨'}${targetVirtualNode ? ` [é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹ ${targetVirtualNode.name} (å“ˆå¸Œ: ${targetVirtualNode.hash})]` : ''}`, 'add_key');
                draw();
                updateRemoveOptions();
                updateStatistics();
                updateVirtualNodesInfo();
            } else if (!name) {
                addLog('è¯·è¾“å…¥æ•°æ®åç§°', 'error');
            } else {
                addLog(`æ•°æ® '${name}' å·²å­˜åœ¨`, 'error');
            }
        });

        removeBtn.addEventListener('click', () => {
            const selected = removeSelect.value;
            if (!selected) return;

            const [type, name] = selected.split('_');
            
            if (type === 'server') {
                const serverIndex = servers.findIndex(s => s.name === name);
                if (serverIndex > -1) {
                    const removedServer = servers.splice(serverIndex, 1)[0];
                    
                    // Remove virtual nodes
                    virtualNodes = virtualNodes.filter(vnode => vnode.server !== removedServer);
                    
                    addLog(`ç§»é™¤æœåŠ¡å™¨ '${name}' (å“ˆå¸Œ: ${removedServer.hash})`, 'remove');
                    remapKeys();
                }
            } else if (type === 'key') {
                const keyIndex = keys.findIndex(k => k.name === name);
                if (keyIndex > -1) {
                    const removedKey = keys.splice(keyIndex, 1)[0];
                    
                    // Update server key count
                    if (removedKey.server) {
                        removedKey.server.keyCount = Math.max(0, (removedKey.server.keyCount || 1) - 1);
                    }
                    
                    addLog(`ç§»é™¤æ•°æ® '${name}' (å“ˆå¸Œ: ${removedKey.hash})`, 'remove');
                    draw();
                    updateStatistics();
                    updateVirtualNodesInfo();
                }
            }
            updateRemoveOptions();
        });

        // Batch operations
        batchAddServersBtn.addEventListener('click', () => {
            const count = parseInt(batchServerCountInput.value);
            const prefix = batchServerPrefixInput.value.trim() || 'server';
            
            if (count > 0 && count <= 20) {
                let addedCount = 0;
                for (let i = 1; i <= count; i++) {
                    const name = `${prefix}-${i}`;
                    if (!servers.find(s => s.name === name)) {
                        const hash = getCurrentHashFunction()(name);
                        const color = colors[colorIndex % colors.length];
                        colorIndex++;
                        
                        const server = { 
                            name, 
                            hash, 
                            color,
                            keyCount: 0
                        };
                        
                        servers.push(server);
                        
                        // Create virtual nodes
                        const serverVirtualNodes = createVirtualNodes(server);
                        virtualNodes.push(...serverVirtualNodes);
                        
                        addedCount++;
                    }
                }
                
                if (addedCount > 0) {
                    addLog(`æ‰¹é‡æ·»åŠ  ${addedCount} ä¸ªæœåŠ¡å™¨ (å‰ç¼€: ${prefix})`, 'batch');
                    batchServerCountInput.value = '';
                    batchServerPrefixInput.value = '';
                    remapKeys();
                    updateRemoveOptions();
                }
            } else {
                addLog('è¯·è¾“å…¥æœ‰æ•ˆçš„æœåŠ¡å™¨æ•°é‡ (1-20)', 'error');
            }
        });

        batchAddKeysBtn.addEventListener('click', () => {
            const count = parseInt(batchKeyCountInput.value);
            const prefix = batchKeyPrefixInput.value.trim() || 'key';
            
            if (count > 0 && count <= 100) {
                let addedCount = 0;
                for (let i = 1; i <= count; i++) {
                    const name = `${prefix}-${i}`;
                    if (!keys.find(k => k.name === name)) {
                        const hash = getCurrentHashFunction()(name);
                        const server = findTargetServer(hash);
                        keys.push({ name, hash, server });
                        
                        if (server) {
                            server.keyCount = (server.keyCount || 0) + 1;
                        }
                        
                        addedCount++;
                    }
                }
                
                if (addedCount > 0) {
                    addLog(`æ‰¹é‡æ·»åŠ  ${addedCount} ä¸ªæ•°æ® (å‰ç¼€: ${prefix})`, 'batch');
                    batchKeyCountInput.value = '';
                    batchKeyPrefixInput.value = '';
                    draw();
                    updateRemoveOptions();
                    updateStatistics();
                    updateVirtualNodesInfo();
                }
            } else {
                addLog('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°æ®æ•°é‡ (1-100)', 'error');
            }
        });

        // Demo scenario
        demoScenarioBtn.addEventListener('click', () => {
            // Reset first
            servers = [];
            virtualNodes = [];
            keys = [];
            migrationHistory = [];
            colorIndex = 0;

            // Add demo servers
            const demoServers = ['web-server-1', 'web-server-2', 'web-server-3'];
            demoServers.forEach(serverName => {
                const hash = getCurrentHashFunction()(serverName);
                const color = colors[colorIndex % colors.length];
                colorIndex++;
                
                const server = { 
                    name: serverName, 
                    hash, 
                    color,
                    keyCount: 0
                };
                
                servers.push(server);
                
                // Create virtual nodes
                const serverVirtualNodes = createVirtualNodes(server);
                virtualNodes.push(...serverVirtualNodes);
            });

            // Add demo keys
            const demoKeys = ['user-123', 'user-456', 'user-789', 'photo-abc', 'photo-def', 'video-xyz', 'doc-001', 'doc-002'];
            demoKeys.forEach(keyName => {
                const hash = getCurrentHashFunction()(keyName);
                const server = findTargetServer(hash);
                keys.push({ name: keyName, hash, server });
                
                if (server) {
                    server.keyCount = (server.keyCount || 0) + 1;
                }
            });

            addLog('åŠ è½½æ¼”ç¤ºåœºæ™¯ï¼š3ä¸ªæœåŠ¡å™¨ï¼Œ8ä¸ªæ•°æ®é¡¹', 'batch');
            draw();
            updateRemoveOptions();
            updateStatistics();
            updateVirtualNodesInfo();
        });

        // Settings changes
        hashFunctionSelect.addEventListener('change', () => {
            // Recalculate all hashes
            servers.forEach(server => {
                server.hash = getCurrentHashFunction()(server.name);
            });
            
            virtualNodes = [];
            servers.forEach(server => {
                const serverVirtualNodes = createVirtualNodes(server);
                virtualNodes.push(...serverVirtualNodes);
            });
            
            keys.forEach(key => {
                key.hash = getCurrentHashFunction()(key.name);
            });
            
            addLog(`åˆ‡æ¢å“ˆå¸Œå‡½æ•°ä¸º: ${hashFunctionSelect.options[hashFunctionSelect.selectedIndex].text}`, 'info');
            remapKeys();
        });

        hashRingSizeSelect.addEventListener('change', () => {
            currentHashRingSize = parseInt(hashRingSizeSelect.value);
            
            // Recalculate all hashes
            servers.forEach(server => {
                server.hash = getCurrentHashFunction()(server.name);
            });
            
            virtualNodes = [];
            servers.forEach(server => {
                const serverVirtualNodes = createVirtualNodes(server);
                virtualNodes.push(...serverVirtualNodes);
            });
            
            keys.forEach(key => {
                key.hash = getCurrentHashFunction()(key.name);
            });
            
            addLog(`å“ˆå¸Œç¯å¤§å°è°ƒæ•´ä¸º: ${currentHashRingSize}`, 'info');
            remapKeys();
        });

        showVirtualNodesCheckbox.addEventListener('change', () => {
            draw();
        });

        resetBtn.addEventListener('click', () => {
            servers = [];
            virtualNodes = [];
            keys = [];
            migrationHistory = [];
            colorIndex = 0;
            logContainer.innerHTML = '';
            addLog('ç³»ç»Ÿå·²é‡ç½®');
            draw();
            updateRemoveOptions();
            updateStatistics();
            updateVirtualNodesInfo();
        });

        clearLogBtn.addEventListener('click', () => {
            logContainer.innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º');
        });

        exportLogBtn.addEventListener('click', () => {
            const logs = Array.from(logContainer.children).map(entry => entry.textContent).reverse();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                timestamp: new Date().toISOString(),
                logs: logs,
                servers: servers.map(s => ({ name: s.name, hash: s.hash, keyCount: s.keyCount })),
                keys: keys.map(k => ({ name: k.name, hash: k.hash, server: k.server ? k.server.name : null })),
                migrationHistory: migrationHistory
            }, null, 2));
            
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `consistent-hash-log-${new Date().toISOString().slice(0,10)}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            addLog('æ—¥å¿—å·²å¯¼å‡º');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        if (serverNameInput.value.trim()) {
                            addServerBtn.click();
                        }
                        break;
                    case 'k':
                        e.preventDefault();
                        if (keyNameInput.value.trim()) {
                            addKeyBtn.click();
                        }
                        break;
                    case 'r':
                        e.preventDefault();
                        resetBtn.click();
                        break;
                }
            }
        });

        // Enter key support
        serverNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addServerBtn.click();
            }
        });

        keyNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addKeyBtn.click();
            }
        });

        // Initial setup
        window.addEventListener('resize', handleResize);
        handleResize();
        addLog('æ¬¢è¿ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œé«˜çº§æ¼”ç¤ºç³»ç»Ÿï¼');
        addLog('å¿«æ·é”®ï¼šCtrl+S æ·»åŠ æœåŠ¡å™¨ï¼ŒCtrl+K æ·»åŠ æ•°æ®ï¼ŒCtrl+R é‡ç½®');
        updateRemoveOptions();
        updateStatistics();
        updateVirtualNodesInfo();
    </script>
</body>
</html>
