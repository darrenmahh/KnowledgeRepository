<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raft ç®—æ³•äº¤äº’å¼æ¨¡æ‹Ÿå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Sky and Indigo (å¤©ç©ºè“ä¸é›è“è‰²) -->
    <!-- Application Structure Plan: ä½œä¸ºä¸€ä¸ªæ—¨åœ¨ç®€åŒ–å¤æ‚æ¦‚å¿µçš„æ•™è‚²å·¥å…·ï¼Œæœ¬åº”ç”¨é‡‡ç”¨åˆ†å±‚é€’è¿›çš„ç»“æ„ã€‚1. é¡¶éƒ¨æ˜¯æ¦‚å¿µä»‹ç»å’Œè§’è‰²å®šä¹‰ï¼Œä¸ºç”¨æˆ·å¥ å®šç†è®ºåŸºç¡€ã€‚2. ä¸­éƒ¨æ˜¯æ ¸å¿ƒçš„äº¤äº’å¼æ¨¡æ‹Ÿå™¨ï¼Œç”¨æˆ·å¯åœ¨æ­¤è¿›è¡Œä¸»åŠ¨æ¢ç´¢ã€‚3. æ¨¡æ‹Ÿå™¨å†…éƒ¨åˆ†ä¸ºå¯è§†åŒ–èŠ‚ç‚¹åŒºåŸŸå’Œæ§åˆ¶/æ—¥å¿—é¢æ¿ã€‚4. åº•éƒ¨æ˜¯å¯¹æ ¸å¿ƒæœºåˆ¶çš„æ€»ç»“ã€‚è¿™ç§ä»â€œç†è®ºâ€åˆ°â€œå®è·µâ€å†åˆ°â€œå›é¡¾â€çš„æµç¨‹ï¼Œç¬¦åˆè®¤çŸ¥è§„å¾‹ï¼Œæ—¨åœ¨é€šè¿‡å¼•å¯¼å¼æ¢ç´¢ï¼Œè®©ç”¨æˆ·åœ¨ä¸åŒå±‚æ¬¡ä¸Šä¸ä¿¡æ¯äº’åŠ¨ï¼Œä»è€Œæ„å»ºå¯¹Raftç®—æ³•çš„å…¨é¢ç†è§£ã€‚ -->
    <!-- Visualization & Content Choices: 1. **èŠ‚ç‚¹çŠ¶æ€**: ä½¿ç”¨ä¸åŒé¢œè‰²å’Œæ ‡ç­¾æ¸…æ™°åŒºåˆ† Leader, Follower, Candidate (HTML/Tailwind + JS class toggling)ã€‚èŠ‚ç‚¹å†…åŠ¨æ€å±•ç¤ºå…¶ä»»æœŸ(Term)å’Œæ—¥å¿—(Log)ï¼Œè®©å†…éƒ¨çŠ¶æ€ä¸€ç›®äº†ç„¶ã€‚[Goal: Inform, Method: Structured HTML]ã€‚2. **RPCåŠ¨ç”»**: ä½¿ç”¨JSåŠ¨æ€åˆ›å»ºå’Œç§»åŠ¨â€œä¿¡å°â€å›¾æ ‡æ¥ä»£è¡¨RequestVoteå’ŒAppendEntries RPCï¼Œå¹¶å°†RPCçš„å†…å®¹ï¼ˆå¦‚Termï¼‰å±•ç¤ºåœ¨åŠ¨ç”»ä¸Šï¼Œè¿™æ¯”é™æ€å›¾è¡¨æ›´èƒ½ä½“ç°ç®—æ³•çš„åŠ¨æ€äº¤äº’è¿‡ç¨‹ã€‚[Goal: Change, Method: JS + CSS Animation]ã€‚3. **é€‰ä¸¾è¿‡ç¨‹**: å°†é¢†å¯¼è€…é€‰ä¸¾çš„è¶…æ—¶å’ŒæŠ•ç¥¨è¿‡ç¨‹è½¬åŒ–ä¸ºå¯ç”±ç”¨æˆ·æ§åˆ¶çš„åˆ†æ­¥åŠ¨ç”»ã€‚ç”¨æˆ·å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°èŠ‚ç‚¹å¦‚ä½•è¶…æ—¶ã€å¦‚ä½•å‘èµ·é€‰ä¸¾ã€å¦‚ä½•æŠ•ç¥¨ã€ä»¥åŠå¦‚ä½•å¤„ç†é€‰ç¥¨ç“œåˆ†çš„æƒ…å†µã€‚[Goal: Compare, Method: JS State + Interactive HTML]ã€‚4. **æ—¥å¿—å¤åˆ¶**: ç”¨æˆ·å¯ä»¥åœ¨LeaderèŠ‚ç‚¹ä¸Šâ€œæ·»åŠ â€æ–°æ—¥å¿—ï¼Œå¹¶è§‚å¯Ÿå…¶å¦‚ä½•é€šè¿‡AppendEntries RPCå¤åˆ¶åˆ°FollowerèŠ‚ç‚¹ï¼Œä»¥åŠCommitç´¢å¼•å¦‚ä½•æ¨è¿›ã€‚[Goal: Change, Method: JS-driven updates]ã€‚ -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f0f9ff; } /* sky-50 */
        .node {
            transition: all 0.4s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-width: 3px;
        }
        .node-follower { border-color: #38bdf8; /* sky-500 */ background-color: white;}
        .node-candidate { border-color: #f59e0b; /* amber-500 */ background-color: #fef9c3; /* yellow-100 */}
        .node-leader { border-color: #4f46e5; /* indigo-600 */ background-color: #e0e7ff; /* indigo-100 */}
        .node-down { border-color: #9ca3af; /* gray-400 */ background-color: #f3f4f6; opacity: 0.6;}
        .message {
            position: absolute;
            z-index: 10;
            transition: all 0.7s ease-in-out;
            opacity: 0;
            font-size: 1.5rem;
            padding: 0.2rem;
        }
        .log-entry { display: flex; justify-content: center; align-items: center; border: 1px solid #94a3b8; width: 30px; height: 30px; font-size: 0.8rem; font-weight: 500;}
        .log-committed { background-color: #86efac; }
        .log-container { min-height: 40px; }
        .explanation-panel { backdrop-filter: blur(5px); background-color: rgba(255,255,255,0.7); }
    </style>
</head>
<body class="text-slate-900">

    <div id="app" class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800">Raft ç®—æ³•äº¤äº’å¼æ¨¡æ‹Ÿå™¨</h1>
            <p class="mt-2 text-lg text-slate-700">ä¸€ä¸ªæ¯” Paxos æ›´æ˜“ç†è§£çš„å…±è¯†ç®—æ³•</p>
        </header>
        
        <main class="bg-white/70 backdrop-blur-lg p-4 sm:p-8 rounded-2xl shadow-xl border border-slate-200">

            <section id="introduction" class="mb-8">
                <h2 class="text-2xl font-bold mb-3 border-b border-sky-300 pb-2 text-indigo-700">æ ¸å¿ƒæ€æƒ³ï¼šåˆ†è€Œæ²»ä¹‹</h2>
                <p class="text-slate-700 leading-relaxed">Raft å°†å¤æ‚çš„å…±è¯†é—®é¢˜åˆ†è§£ä¸ºä¸‰ä¸ªæ›´æ˜“äºç®¡ç†çš„å­é—®é¢˜ï¼š<strong class="text-sky-600">é¢†å¯¼è€…é€‰ä¸¾ (Leader Election)</strong>ã€<strong class="text-sky-600">æ—¥å¿—å¤åˆ¶ (Log Replication)</strong> å’Œ <strong class="text-sky-600">å®‰å…¨æ€§ (Safety)</strong>ã€‚é€šè¿‡æ˜ç¡®çš„é¢†å¯¼è€…è§’è‰²ï¼ŒRaft ç®€åŒ–äº†ç³»ç»Ÿæ“ä½œæµç¨‹ï¼Œä½¿å¾—æ•´ä¸ªç®—æ³•æµç¨‹æ›´åŠ æ¸…æ™°å’Œç¡®å®šã€‚</p>
            </section>

            <section id="simulator-container" class="relative">
                <div id="visual-pane" class="grid grid-cols-3 md:grid-cols-5 gap-4 md:gap-6 min-h-[400px]">
                    <!-- èŠ‚ç‚¹å°†ç”±JSåŠ¨æ€æ’å…¥ -->
                </div>

                <div id="explanation-panel" class="absolute inset-0 flex items-center justify-center p-8 rounded-xl transition-opacity duration-500 opacity-0 pointer-events-none">
                    <p id="explanation-text" class="text-2xl font-bold text-center text-indigo-800 bg-white/80 p-6 rounded-lg shadow-md"></p>
                </div>
            </section>

            <section id="controls" class="mt-8 p-4 bg-sky-50 rounded-lg border border-sky-200">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <label for="scenario-select" class="font-medium">é€‰æ‹©åœºæ™¯:</label>
                        <select id="scenario-select" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="election">1. é¢†å¯¼è€…é€‰ä¸¾</option>
                            <option value="log_replication">2. æ—¥å¿—å¤åˆ¶</option>
                            <option value="leader_fail">3. é¢†å¯¼è€…å¤±æ•ˆä¸å†é€‰ä¸¾</option>
                        </select>
                    </div>
                    <div class="flex gap-3">
                         <button id="reset-btn" class="bg-slate-500 text-white py-2 px-5 rounded-md hover:bg-slate-600 font-semibold transition-colors">é‡ç½®</button>
                         <button id="next-step-btn" class="bg-indigo-600 text-white py-2 px-5 rounded-md hover:bg-indigo-700 font-semibold transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                             <span>ä¸‹ä¸€æ­¥</span>
                             <span class="font-mono text-lg">&rarr;</span>
                         </button>
                    </div>
                </div>
            </section>

        </main>
    </div>

<script>
    const visualPane = document.getElementById('visual-pane');
    const explanationPanel = document.getElementById('explanation-panel');
    const explanationText = document.getElementById('explanation-text');
    const scenarioSelect = document.getElementById('scenario-select');
    const resetBtn = document.getElementById('reset-btn');
    const nextStepBtn = document.getElementById('next-step-btn');

    let state = {};

    const scenarios = {
        election: {
            nodes: 5,
            steps: [
                { type: 'text', text: 'Raft é›†ç¾¤å¯åŠ¨ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ Follower çŠ¶æ€ï¼Œæ‹¥æœ‰ä¸€ä¸ªéšæœºçš„é€‰ä¸¾è¶…æ—¶ã€‚' },
                { type: 'timeout', node: 2, text: 'èŠ‚ç‚¹ S3 çš„é€‰ä¸¾è®¡æ—¶å™¨é¦–å…ˆè¶…æ—¶...' },
                { type: 'state_change', node: 2, newState: 'Candidate', term: 1, text: 'S3 æˆä¸º Candidateï¼Œä»»æœŸ Term å¢åŠ åˆ° 1ï¼Œå¹¶ä¸ºè‡ªå·±æŠ•ç¥¨ã€‚' },
                { type: 'rpc', from: 2, to: [0, 1, 3, 4], rpc_type: 'RequestVote', text: 'S3 å‘æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚ã€‚' },
                { type: 'vote', from: 0, to: 2, grant: true, text: 'S1 æŠ•ç¥¨ç»™ S3ã€‚' },
                { type: 'vote', from: 1, to: 2, grant: true, text: 'S2 æŠ•ç¥¨ç»™ S3ã€‚' },
                { type: 'vote', from: 3, to: 2, grant: true, text: 'S4 æŠ•ç¥¨ç»™ S3ã€‚S3 å·²è·å¾—å¤šæ•°é€‰ç¥¨(4/5)ã€‚' },
                { type: 'state_change', node: 2, newState: 'Leader', text: 'S3 æˆä¸º Leaderï¼' },
                { type: 'rpc', from: 2, to: [0, 1, 3, 4], rpc_type: 'AppendEntries', text: 'æ–°çš„ Leader S3 å¼€å§‹å‘é€å¿ƒè·³ä»¥ç»´æŒåœ°ä½ã€‚' },
                { type: 'text', text: 'é¢†å¯¼è€…é€‰ä¸¾æˆåŠŸï¼' }
            ]
        },
        log_replication: {
            nodes: 5,
            initialState: { leader: 2, term: 1, logs: [[],[],[{term: 1}],[],[]] },
            steps: [
                { type: 'text', text: 'ä¸€ä¸ªç¨³å®šçš„é›†ç¾¤ï¼ŒS3 æ˜¯ Leaderã€‚' },
                { type: 'client_request', to: 2, log: {term: 1}, text: 'å®¢æˆ·ç«¯å‘ Leader S3 å‘é€ä¸€ä¸ªå†™è¯·æ±‚ã€‚' },
                { type: 'log_add', node: 2, log: {term: 1}, text: 'Leader S3 å°†æ–°æ—¥å¿—è¿½åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼ˆä½†å°šæœªæäº¤ï¼‰ã€‚' },
                { type: 'rpc', from: 2, to: [0, 1, 3, 4], rpc_type: 'AppendEntries', text: 'Leader S3 å¹¶è¡Œåœ°å°†æ–°æ—¥å¿—æ¡ç›®å¤åˆ¶ç»™æ‰€æœ‰ Followerã€‚' },
                { type: 'log_replicated', node: 0, text: 'S1 æˆåŠŸå¤åˆ¶æ—¥å¿—ã€‚' },
                { type: 'log_replicated', node: 1, text: 'S2 æˆåŠŸå¤åˆ¶æ—¥å¿—ã€‚' },
                { type: 'log_replicated', node: 3, text: 'S4 æˆåŠŸå¤åˆ¶æ—¥å¿—ã€‚Leader å·²æ”¶åˆ°å¤šæ•°èŠ‚ç‚¹çš„ç¡®è®¤ã€‚' },
                { type: 'commit', node: 2, index: 1, text: 'Leader S3 æäº¤è¯¥æ—¥å¿—æ¡ç›®ã€‚' },
                { type: 'rpc', from: 2, to: [0, 1, 3, 4], rpc_type: 'AppendEntries', text: 'Leader åœ¨ä¸‹ä¸€æ¬¡å¿ƒè·³ä¸­é€šçŸ¥æ‰€æœ‰ Follower æäº¤è¯¥æ—¥å¿—ã€‚' },
                { type: 'commit', node: 0, index: 1, text: 'S1 æäº¤æ—¥å¿—ã€‚' },
                { type: 'commit', node: 1, index: 1, text: 'S2 æäº¤æ—¥å¿—ã€‚' },
                { type: 'commit', node: 3, index: 1, text: 'S4 æäº¤æ—¥å¿—ã€‚' },
                { type: 'text', text: 'æ—¥å¿—å¤åˆ¶å¹¶æäº¤æˆåŠŸï¼é›†ç¾¤çŠ¶æ€è¾¾æˆä¸€è‡´ã€‚' }
            ]
        },
        leader_fail: {
            nodes: 5,
            initialState: { leader: 2, term: 2, logs: Array(5).fill([]).map(()=>[{term:1},{term:2}]) },
            steps: [
                { type: 'text', text: 'é›†ç¾¤ç¨³å®šè¿è¡Œï¼ŒS3 æ˜¯ Leaderã€‚' },
                { type: 'fail', node: 2, text: 'çªç„¶ï¼ŒLeader S3 å®•æœºï¼' },
                { type: 'text', text: 'Follower ä»¬å°†å› æ”¶ä¸åˆ°å¿ƒè·³è€Œè§¦å‘é€‰ä¸¾è¶…æ—¶...' },
                { type: 'timeout', node: 4, text: 'èŠ‚ç‚¹ S5 çš„é€‰ä¸¾è®¡æ—¶å™¨é¦–å…ˆè¶…æ—¶...' },
                { type: 'state_change', node: 4, newState: 'Candidate', term: 3, text: 'S5 æˆä¸º Candidateï¼Œä»»æœŸ Term å¢åŠ åˆ° 3ï¼Œä¸ºè‡ªå·±æŠ•ç¥¨ã€‚' },
                { type: 'rpc', from: 4, to: [0, 1, 3], rpc_type: 'RequestVote', text: 'S5 å‘å…¶ä»–å­˜æ´»èŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚ã€‚' },
                { type: 'vote', from: 0, to: 4, grant: true, text: 'S1 æŠ•ç¥¨ç»™ S5ã€‚' },
                { type: 'vote', from: 1, to: 4, grant: true, text: 'S2 æŠ•ç¥¨ç»™ S5ã€‚' },
                { type: 'vote', from: 3, to: 4, grant: true, text: 'S4 æŠ•ç¥¨ç»™ S5ã€‚S5 è·å¾—å¤šæ•°é€‰ç¥¨(4/4)ã€‚' },
                { type: 'state_change', node: 4, newState: 'Leader', text: 'S5 æˆä¸ºæ–°çš„ Leaderï¼' },
                { type: 'rpc', from: 4, to: [0, 1, 3], rpc_type: 'AppendEntries', text: 'æ–° Leader S5 å¼€å§‹å‘é€å¿ƒè·³ï¼Œé›†ç¾¤æ¢å¤æœåŠ¡ã€‚' },
            ]
        }
    };
    
    function init() {
        const scenario = scenarios[scenarioSelect.value];
        state = {
            nodes: Array.from({ length: scenario.nodes }, (_, i) => ({
                id: i,
                el: null,
                state: 'Follower',
                term: 0,
                logs: [],
                commitIndex: -1,
            })),
            currentStep: 0
        };

        if (scenario.initialState) {
            state.nodes.forEach((node, i) => {
                node.term = scenario.initialState.term || 0;
                node.logs = JSON.parse(JSON.stringify(scenario.initialState.logs[i] || []));
                node.commitIndex = (scenario.initialState.logs[i] || []).length - 1;
            });
            if(scenario.initialState.leader !== undefined) {
                 state.nodes[scenario.initialState.leader].state = 'Leader';
            }
        }
        
        render();
        hideExplanation();
        nextStepBtn.disabled = false;
    }

    function render() {
        visualPane.innerHTML = '';
        state.nodes.forEach(node => {
            const el = document.createElement('div');
            el.id = `node-${node.id}`;
            el.className = `node p-4 rounded-lg flex flex-col items-center`;
            
            const logsHTML = `<div class="log-container flex gap-1 mt-2 flex-wrap justify-center">${node.logs.map((log, index) => `<div class="log-entry ${index <= node.commitIndex ? 'log-committed' : ''}">${log.term}</div>`).join('')}</div>`;

            el.innerHTML = `
                <div class="font-bold text-lg">S${node.id + 1}</div>
                <div class="text-sm font-medium" id="state-${node.id}"></div>
                <div class="text-xs" id="term-${node.id}"></div>
                ${logsHTML}
            `;
            visualPane.appendChild(el);
            node.el = el;
        });
        updateNodeClasses();
    }

    function updateNodeClasses() {
        state.nodes.forEach(node => {
            node.el.classList.remove('node-follower', 'node-candidate', 'node-leader', 'node-down');
            node.el.classList.add(`node-${node.state.toLowerCase()}`);
            node.el.querySelector(`#state-${node.id}`).textContent = node.state;
            node.el.querySelector(`#term-${node.id}`).textContent = `Term: ${node.term}`;
            const logsHTML = `<div class="log-container flex gap-1 mt-2 flex-wrap justify-center">${node.logs.map((log, index) => `<div class="log-entry ${index <= node.commitIndex ? 'log-committed' : ''}">${log.term}</div>`).join('')}</div>`;
            node.el.querySelector('.log-container').outerHTML = logsHTML;

        });
    }

    function showExplanation(text) {
        explanationText.textContent = text;
        explanationPanel.style.opacity = '1';
        explanationPanel.style.pointerEvents = 'auto';
    }

    function hideExplanation() {
        explanationPanel.style.opacity = '0';
        explanationPanel.style.pointerEvents = 'none';
    }
    
    function animateRPC(fromNode, toNodes, rpc_type) {
        const fromEl = fromNode.el;
        toNodes.forEach(toNode => {
            const toEl = toNode.el;
            if(!toEl || toNode.state === 'Down') return;

            const msg = document.createElement('div');
            msg.className = 'message';
            msg.innerHTML = rpc_type === 'RequestVote' ? 'ğŸ—³ï¸' : 'â¤ï¸';
            if (rpc_type === 'RequestVote') msg.style.color = '#f59e0b';
            if (rpc_type === 'AppendEntries') msg.style.color = '#4f46e5';

            const startRect = fromEl.getBoundingClientRect();
            const endRect = toEl.getBoundingClientRect();
            const containerRect = visualPane.getBoundingClientRect();

            msg.style.left = `${startRect.left + startRect.width / 2 - containerRect.left}px`;
            msg.style.top = `${startRect.top + startRect.height / 2 - containerRect.top}px`;
            
            visualPane.appendChild(msg);

            requestAnimationFrame(() => {
                msg.style.opacity = '1';
                msg.style.left = `${endRect.left + endRect.width / 2 - containerRect.left}px`;
                msg.style.top = `${endRect.top + endRect.height / 2 - containerRect.top}px`;
            });

            setTimeout(() => {
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 700);
            }, 700);
        });
    }

    function next() {
        hideExplanation();
        const scenario = scenarios[scenarioSelect.value];
        if (state.currentStep >= scenario.steps.length) {
            return;
        }

        const step = scenario.steps[state.currentStep];
        
        setTimeout(() => showExplanation(step.text), 100);

        switch (step.type) {
            case 'state_change':
                state.nodes[step.node].state = step.newState;
                if (step.term) state.nodes[step.node].term = step.term;
                break;
            case 'rpc':
                const fromNode = state.nodes[step.from];
                const toNodes = step.to.map(i => state.nodes[i]);
                animateRPC(fromNode, toNodes, step.rpc_type);
                break;
            case 'fail':
                 state.nodes[step.node].state = 'Down';
                break;
            case 'log_add':
                 state.nodes[step.node].logs.push(step.log);
                 break;
            case 'commit':
                 state.nodes[step.node].commitIndex = step.index;
                 break;
        }
        
        updateNodeClasses();
        state.currentStep++;
        
        if (state.currentStep >= scenario.steps.length) {
             nextStepBtn.disabled = true;
             setTimeout(() => showExplanation('æ¨¡æ‹Ÿç»“æŸï¼ç‚¹å‡»â€œé‡ç½®â€ä»¥é€‰æ‹©å…¶ä»–åœºæ™¯ã€‚'), 100);
        }
    }
    
    nextStepBtn.addEventListener('click', next);
    resetBtn.addEventListener('click', init);
    scenarioSelect.addEventListener('change', init);
    
    window.onload = init;
</script>

</body>
</html>
c